<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Isekai Guild Officer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --ev-green: #58b05c; --ev-blue: #4a90e2; --ev-dark: #2c3e50; --ev-yellow: #f1c40f; --ev-orange: #e67e22; --ev-pink: #ff78b5; }
        /* 100dvh ensures it fits mobile screens perfectly including URL bars */
        body { background: #f0f4f8; color: #2c3e50; font-family: 'Montserrat', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; transition: background 1s ease; height: 100dvh; }
        body.night-mode { background: #1a202c; color: #e2e8f0; }
        .game-font { font-family: 'Fredoka One', cursive; }
        
        /* Star Styling */
        .star-active { color: var(--ev-yellow); text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); font-size: 12px; }
        .star-empty { color: #dfe6e9; font-size: 12px; }

        /* Station Row */
        .station-row { background: white; border-radius: 15px; margin: 10px; padding: 15px; display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; transition: all 0.3s ease; border: 2px solid transparent; }
        
        .station-row.locked { opacity: 0.6; filter: grayscale(1); background: #e2e8f0; }
        .night-mode .station-row.locked { background: #1a202c; opacity: 0.5; }

        .station-row.unlockable { opacity: 1; filter: none; background: #f0fdf4; border-color: #4ade80; transform: scale(1.02); }
        .night-mode .station-row.unlockable { background: #064e3b; border-color: #34d399; }

        .night-mode .station-row { background: #2d3748; color: white; }
        .icon-circle { width: 65px; height: 65px; background: #eef2f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; flex-shrink: 0; }
        .night-mode .icon-circle { background: #4a5568; }
        
        .bar-container { flex: 1; height: 26px; background: #dfe6e9; border-radius: 13px; overflow: hidden; position: relative; }
        .night-mode .bar-container { background: #4a5568; }
        .bar-fill { height: 100%; width: 0%; background: var(--ev-green); transition: width 0.1s linear; }
        .bar-text { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 10px; font-weight: bold; color: rgba(0,0,0,0.5); }
        .night-mode .bar-text { color: rgba(255,255,255,0.7); }

        /* Boost Timer - Raised Higher */
        #boost-timer-ui { position: fixed; bottom: 130px; left: 0; right: 0; display: flex; justify-content: center; z-index: 60; pointer-events: none; transition: 0.3s; opacity: 0; transform: translateY(20px); }
        #boost-timer-ui.visible { opacity: 1; transform: translateY(0); }
        .timer-tab { background: #2c3e50; color: white; width: 180px; height: 32px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; gap: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Navigation - Increased Height and Padding for Mobile Bars */
        nav { 
            background: white; 
            border-top: 1px solid #ddd; 
            height: 110px; /* Taller */
            display: flex; 
            justify-content: space-around; 
            align-items: flex-start; /* Items start at top */
            padding-top: 15px;
            z-index: 50; 
            padding-bottom: 40px; /* Space for Android/iOS bar */
        }
        .night-mode nav { background: #2d3748; border-color: #4a5568; }
        .nav-btn { position: relative; font-size: 24px; filter: grayscale(1); opacity: 0.6; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 2px; width: 33%; }
        .nav-btn span { font-size: 10px; font-weight: bold; }
        .nav-btn.active { filter: grayscale(0); opacity: 1; transform: scale(1.05); color: var(--ev-blue); }
        .night-mode .nav-btn.active { color: var(--ev-green); }
        
        .nav-btn.boost-active { filter: grayscale(0) !important; opacity: 1 !important; color: var(--ev-green) !important; animation: pulse 2s infinite; }
        .btn-disabled { opacity: 0.5 !important; pointer-events: none !important; filter: grayscale(1); }
        .btn-pulse { animation: pulse 1.5s infinite; }

        .float-text { position: absolute; font-weight: bold; font-size: 14px; pointer-events: none; animation: floatUp 1s forwards; color: var(--ev-yellow); text-shadow: 1px 1px 0 #000; z-index: 100; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

        .adventurer { position: absolute; font-size: 40px; z-index: 900; animation: walkAcross 10s linear; cursor: pointer; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2)); transition: transform 0.1s; }
        .adventurer:active { transform: scale(0.9); }
        @keyframes walkAcross { from { left: -50px; } to { left: 110%; } }

        .avatar-container { font-size: 50px; line-height: 1; position: relative; display: inline-block; }
        .avatar-acc { position: absolute; top: -10px; right: -10px; font-size: 30px; animation: bounce 2s infinite; }

        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 150px; }
        .tab-content.active { display: flex; flex-direction: column; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- END GAME / RETIRE SCREEN -->
    <div id="end-screen" class="fixed inset-0 z-[2000] hidden flex flex-col items-center justify-center p-6 bg-slate-900 text-white text-center">
        <h1 class="game-font text-4xl mb-2 text-yellow-400">RETIRED</h1>
        <p class="text-sm text-slate-400 mb-8 uppercase tracking-widest">You left the guild life.</p>
        
        <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-sm mb-8 border border-slate-700 shadow-2xl">
            <p class="text-xs text-slate-500 mb-1">YOU HAVE WASTED</p>
            <h2 class="game-font text-3xl mb-6 text-white" id="end-time-display">00m 00s</h2>
            <p class="text-xs text-slate-500 mb-1">OF YOUR LIFE CLICKING</p>
            <h2 class="game-font text-3xl text-emerald-400" id="end-upgrades-display">0</h2>
            <p class="text-xs text-slate-500 mt-1">UPGRADES</p>
        </div>

        <button onclick="location.reload()" class="bg-white text-slate-900 px-10 py-4 rounded-full game-font hover:scale-105 transition">START NEW LIFE</button>
    </div>

    <!-- CUSTOM ALERT -->
    <div id="custom-alert" class="fixed inset-0 z-[1000] hidden flex items-center justify-center p-6 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 text-center shadow-2xl animate__animated animate__zoomIn max-w-sm w-full">
            <div class="text-4xl mb-2">‚ö°</div>
            <h2 class="game-font text-xl text-slate-800 mb-2">BOOST ACTIVATED!</h2>
            <p class="text-sm text-slate-500 mb-6">Speed x2 for 5 minutes.</p>
            <button onclick="closeAlert()" class="bg-emerald-500 text-white px-8 py-3 rounded-full font-bold shadow-lg active:scale-95 transition">OK!</button>
        </div>
    </div>

    <!-- PRESTIGE MODAL -->
    <div id="prestige-modal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 text-center shadow-2xl animate__animated animate__fadeInUp max-w-sm w-full border-4 border-yellow-400">
            <div class="text-5xl mb-2">üëë</div>
            <h2 class="game-font text-2xl text-yellow-600 mb-2">RELOCATE?</h2>
            <p class="text-xs text-slate-500 mb-4">Move from <span id="current-loc" class="font-bold">Village</span> to <span id="next-loc" class="font-bold">Town</span>.</p>
            <div class="bg-red-50 p-3 rounded-xl mb-4 text-xs text-red-500 text-left">
                ‚ùå Lose all Guild Gold<br>‚ùå Reset all Station Levels
            </div>
            <div class="bg-green-50 p-3 rounded-xl mb-6 text-xs text-green-600 text-left">
                ‚úÖ Keep Partner & Home<br>‚úÖ Keep Personal Gold<br>‚úÖ <span class="font-bold">Income x2 FOREVER</span>
            </div>
            <div class="flex gap-2">
                <button onclick="closePrestige()" class="flex-1 bg-slate-200 text-slate-600 py-3 rounded-xl font-bold">CANCEL</button>
                <button onclick="confirmPrestige()" class="flex-1 bg-yellow-400 text-yellow-900 py-3 rounded-xl font-bold shadow-lg">RELOCATE</button>
            </div>
        </div>
    </div>

    <!-- SPLASH -->
    <div id="splash" class="fixed inset-0 z-[500] flex flex-col items-center justify-center text-center p-6 bg-slate-900">
        <h1 class="game-font text-4xl text-white mb-2 tracking-widest animate__animated animate__fadeInDown">ISEKAI GUILD</h1>
        <p class="text-[10px] tracking-[0.4em] text-cyan-400 mb-8 animate__animated animate__fadeIn">MASTER'S LEGACY</p>
        <button onclick="startGame()" class="bg-cyan-400 text-slate-900 px-10 py-3 rounded-full game-font animate__animated animate__pulse animate__infinite">START GAME</button>
        <p class="text-[10px] text-slate-600 mt-4">Full Screen Recommended</p>
    </div>

    <!-- HEADER (3 Columns for Full Screen Btn) -->
    <header class="bg-white px-2 py-2 shadow-sm z-40 grid grid-cols-[1fr_auto_1fr] gap-2 items-center transition-colors duration-500" id="header-1">
        <div class="flex items-center justify-center gap-2 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100 overflow-hidden">
            <span class="text-sm">üèõÔ∏è</span><span id="gold-display" class="game-font text-emerald-600 truncate">0</span>
        </div>
        
        <!-- Full Screen Toggle -->
        <button onclick="toggleFullScreen()" class="text-slate-400 text-xl px-2 active:scale-90 transition">‚õ∂</button>

        <div class="flex items-center justify-center gap-2 bg-pink-50 px-2 py-1 rounded-full border border-pink-100 overflow-hidden">
            <span class="text-sm">üè†</span><span id="p-gold-display" class="game-font text-pink-600 truncate">0</span>
        </div>
    </header>

    <!-- INFO BAR -->
    <div class="bg-slate-100 h-8 flex justify-between items-center px-4 shadow-inner z-30 border-b border-slate-200 transition-colors duration-500" id="header-2">
        <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Day <span id="day-display">1</span> <span id="loc-display" class="ml-2 text-indigo-400">Village</span></div>
        <div class="text-[10px] font-bold text-slate-500 font-mono bg-white px-2 py-0.5 rounded shadow-sm border border-slate-200">
            SHIFT: <span id="shift-timer-display">05:00</span>
        </div>
    </div>

    <!-- LAYERS -->
    <div id="adventurer-layer" class="absolute inset-0 z-30 pointer-events-none overflow-hidden h-full w-full"></div>
    <div id="float-layer" class="absolute inset-0 z-50 pointer-events-none overflow-hidden h-full w-full"></div>

    <main class="flex-1 relative overflow-hidden bg-[#f8fafc]">
        
        <!-- BOND TAB -->
        <section id="tab-bond" class="tab-content p-4">
            <div class="space-y-4 animate__animated animate__fadeIn">
                <!-- Avatar & Status -->
                <div class="bg-white p-6 rounded-3xl shadow-lg border-2 border-pink-50 text-center relative overflow-hidden">
                    <div id="date-night-banner" class="hidden absolute top-0 left-0 w-full bg-pink-500 text-white text-[10px] font-bold py-1 uppercase tracking-widest">Weekend Date Night!</div>
                    <div class="mb-4"><div class="avatar-container"><span id="partner-base">üë§</span><span id="partner-acc" class="avatar-acc"></span></div></div>
                    <p id="bond-msg" class="italic text-slate-600 mb-2 text-sm">"Shift is over! Time to rest."</p>
                    <h2 class="text-3xl game-font text-emerald-500 mb-4" id="earnings-display">+0g</h2>
                    <button onclick="startNextDay()" class="w-full py-4 bg-indigo-500 text-white rounded-2xl game-font shadow-lg active:scale-95 transition">SLEEP (START DAY)</button>
                </div>

                <!-- Statistics -->
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <p class="game-font text-[10px] text-slate-400 mb-3 uppercase">Career Stats</p>
                    <div class="flex justify-between items-center text-xs text-slate-600 mb-1">
                        <span>Time Wasted:</span><span id="stat-time" class="font-mono font-bold">0m</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-slate-600">
                        <span>Total Upgrades:</span><span id="stat-upgrades" class="font-mono font-bold">0</span>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <p class="game-font text-[10px] text-slate-400 mb-3 uppercase">Story Log</p>
                    <div id="episode-list" class="space-y-2 text-sm text-slate-600"></div>
                </div>

                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <p class="game-font text-[10px] text-slate-400 mb-3 uppercase">Partner Gifts (Global Income+)</p>
                    <div id="partner-shop" class="space-y-2"></div>
                </div>

                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <p class="game-font text-[10px] text-slate-400 mb-3 uppercase">Home Furniture (Commission+)</p>
                    <div id="home-shop" class="space-y-2"></div>
                </div>

                <!-- RETIRE BUTTON -->
                <button onclick="retireGame()" class="w-full py-4 border-2 border-red-100 bg-red-50 text-red-400 rounded-2xl font-bold text-xs hover:bg-red-100 transition mt-4 mb-20">
                    RETIRE FROM GUILD (END GAME)
                </button>
            </div>
        </section>

        <!-- GUILD TAB -->
        <section id="tab-guild" class="tab-content active">
            <!-- Quest Banner -->
            <div id="quest-banner" class="mx-4 mt-4 bg-blue-50 border border-blue-200 rounded-xl p-3 flex justify-between items-center shadow-sm">
                <div>
                    <p id="quest-label" class="text-[9px] font-bold text-blue-400 uppercase">Daily Quest</p>
                    <p id="quest-desc" class="text-xs font-bold text-slate-600">Loading...</p>
                </div>
                <div class="text-right">
                    <p id="quest-progress" class="text-xs font-mono text-slate-500">0/0</p>
                    <p id="quest-reward-text" class="text-[9px] text-yellow-600 font-bold">Reward: 100 üè†</p>
                </div>
            </div>
            
            <div id="stations-container" class="pb-20"></div>

            <div id="relocate-btn-container" class="hidden p-4 pb-24">
                <button onclick="showPrestigeModal()" class="w-full bg-gradient-to-r from-yellow-400 to-orange-400 text-white py-3 rounded-xl font-bold shadow-lg animate-pulse">üëë PRESTIGE: RELOCATE GUILD</button>
            </div>
        </section>

        <!-- SHOP TAB -->
        <section id="tab-shop" class="tab-content p-4">
            <h2 class="game-font text-xl mb-4 text-slate-700">Infrastructure</h2>
            <div id="shop-list" class="space-y-3 pb-24"></div>
        </section>
    </main>

    <!-- FLOATING BOOST TIMER -->
    <div id="boost-timer-ui">
        <div class="timer-tab bg-slate-800">
            <span class="text-orange-400">‚ö° BOOST: <span id="boost-timer-text" class="font-mono text-white">00:00</span></span>
        </div>
    </div>

    <!-- NAV -->
    <nav>
        <button onclick="activateBoost()" class="nav-btn" id="btn-boost">
            <div class="text-2xl">‚ö°</div>
            <span>BOOST</span>
        </button>
        <button onclick="switchTab('tab-guild', this)" class="nav-btn active" id="btn-guild">
            <div class="text-2xl">üèõÔ∏è</div>
            <span>GUILD</span>
        </button>
        <button onclick="switchTab('tab-shop', this)" class="nav-btn" id="btn-shop">
            <div class="text-2xl">‚¨ÜÔ∏è</div>
            <span>UPGRADES</span>
        </button>
    </nav>

    <script>
        // --- CONFIG & STATE ---
        let gold = 50, pGold = 0;
        let globalMult = 1.0, commissionMult = 0.1; // 10% base
        let boostX2 = 1.0, boostSeconds = 0;
        let day = 1;
        let prestigeLevel = 0;
        const locations = ["Village", "Town", "Capital", "Kingdom"];
        
        const SHIFT_DURATION = 300; 
        let currentShiftTime = SHIFT_DURATION;
        let isShiftActive = true;
        let shiftEarnings = 0;

        // Statistics
        let totalTimePlayed = 0; 
        let totalUpgradesPurchased = 0;

        // Quests
        let dailyQuest = null;
        let questCompletedCount = 0;

        // DATA
        let stations = {
            clerk: { id: 'clerk', icon: 'üë®‚Äçüíº', name: 'Clerk', lvl: 1, max: 50, cost: 50, income: 5, speed: 2.0, unlocked: true, progress: 0 },
            quest: { id: 'quest', icon: 'üìú', name: 'Quests', lvl: 0, max: 50, cost: 250, income: 25, speed: 1.5, unlocked: false, progress: 0 },
            alch:  { id: 'alch', icon: '‚öóÔ∏è', name: 'Alchemist', lvl: 0, max: 50, cost: 1000, income: 80, speed: 1.2, unlocked: false, progress: 0 },
            tavern:{ id: 'tavern', icon: 'üç∫', name: 'Tavern', lvl: 0, max: 50, cost: 5000, income: 300, speed: 0.8, unlocked: false, progress: 0 },
            smith: { id: 'smith', icon: '‚öíÔ∏è', name: 'Smith', lvl: 0, max: 50, cost: 15000, income: 1000, speed: 0.6, unlocked: false, progress: 0 },
            magic: { id: 'magic', icon: 'üîÆ', name: 'Mage', lvl: 0, max: 50, cost: 50000, income: 4000, speed: 0.4, unlocked: false, progress: 0 }
        };

        const infrastructure = [
            { id: 0, name: "Rubber Stamp", desc: "Clerk Speed x2", cost: 200, type: "clerk", bought: false },
            { id: 1, name: "Notice Board", desc: "Quests Income x2", cost: 1000, type: "quest", bought: false },
            { id: 2, name: "Glass Vials", desc: "Alchemist Speed x2", cost: 4000, type: "alch", bought: false },
            { id: 3, name: "Beer Mugs", desc: "Tavern Income x2", cost: 20000, type: "tavern", bought: false },
            { id: 4, name: "Auto Hammer", desc: "Smith Speed x2", cost: 60000, type: "smith", bought: false },
            { id: 5, name: "Comfy Chair", desc: "Clerk Income x2", cost: 5000, type: "clerk", bought: false },
            { id: 6, name: "Red Markers", desc: "Quests Speed x2", cost: 15000, type: "quest", bought: false },
            { id: 7, name: "Bunsen Burner", desc: "Alchemist Income x2", cost: 50000, type: "alch", bought: false },
            { id: 8, name: "Jukebox", desc: "Tavern Speed x2", cost: 150000, type: "tavern", bought: false },
            { id: 9, name: "Lava Forge", desc: "Smith Income x2", cost: 500000, type: "smith", bought: false },
            { id: 10, name: "Coffee Machine", desc: "Clerk Speed x5", cost: 100000, type: "clerk", bought: false },
            { id: 11, name: "Dragon Blood", desc: "Alchemist Speed x5", cost: 1000000, type: "alch", bought: false },
            { id: 12, name: "Mana Crystal", desc: "Mage Income x2", cost: 200000, type: "magic", bought: false }
        ];

        // SCALING HOME ITEMS
        const partnerGifts = [
            { id: 0, name: "Flowers", baseCost: 100, lvl: 0, desc: "Global Income +5%", icon: "üíê" },
            { id: 1, name: "Chocolate", baseCost: 500, lvl: 0, desc: "Global Income +10%", icon: "üç´" },
            { id: 2, name: "Ring", baseCost: 5000, lvl: 0, desc: "Global Income +25%", icon: "üíç" }
        ];

        const homeFurniture = [
            { id: 0, name: "New Rug", baseCost: 200, lvl: 0, desc: "Commission +1%" },
            { id: 1, name: "Soft Bed", baseCost: 1000, lvl: 0, desc: "Commission +2%" },
            { id: 2, name: "Painting", baseCost: 3000, lvl: 0, desc: "Commission +5%" }
        ];

        const episodes = [
            { day: 1, text: "Opened the guild. It's quiet." },
            { day: 2, text: "First adventurer walked in!" },
            { day: 5, text: "The tavern is getting rowdy." }
        ];

        // --- CORE FUNCTIONS ---
        function startGame() { 
            document.getElementById('splash').style.display='none'; 
            // Try fullscreen
            if(document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }
            
            initStationDOM(); 
            initShopDOM(); 
            generateQuest();
            renderBondItems(); renderEpisodes();
            startLoops();
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function startLoops() {
            // High Speed Game Loop
            window.gameIntervals = [];
            window.gameIntervals.push(setInterval(() => {
                if(isShiftActive) {
                    for(let id in stations) { 
                        if(stations[id].unlocked && stations[id].lvl > 0) tick(id); 
                    }
                    document.getElementById('gold-display').innerText = formatNum(gold);
                }
            }, 20));

            // 1 Second Loop
            window.gameIntervals.push(setInterval(() => {
                totalTimePlayed++;
                updateStatsUI();
                checkButtons();
                updateStationVisuals(); 
                updateShopVisuals(); 
                
                if(boostSeconds > 0) {
                    boostSeconds--;
                    document.getElementById('boost-timer-text').innerText = formatTime(boostSeconds);
                    if(boostSeconds <= 0) { 
                        boostX2 = 1.0; 
                        document.getElementById('btn-boost').classList.remove('boost-active');
                        document.getElementById('boost-timer-ui').classList.remove('visible');
                    }
                }

                if(isShiftActive) {
                    currentShiftTime--;
                    document.getElementById('shift-timer-display').innerText = formatTime(currentShiftTime);
                    if(Math.random() < 0.2) spawnAdventurer();
                    if(currentShiftTime <= 0) autoGoHome();
                }
            }, 1000));
        }

        // --- DOM RENDERER (GUILD) ---
        function initStationDOM() {
            let container = document.getElementById('stations-container');
            container.innerHTML = "";
            for(let id in stations) {
                let s = stations[id];
                let row = document.createElement('div');
                row.className = "station-row";
                row.id = `row-${id}`;
                
                row.innerHTML = `
                    <div class="icon-circle">${s.icon}</div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-bold text-slate-400 uppercase">${s.name} <span class="text-slate-300 ml-1" id="lvl-${id}">Lv.1</span></span>
                            <div id="stars-${id}"></div>
                        </div>
                        <div class="bar-container">
                            <div class="bar-text" id="income-${id}">+0g</div>
                            <div id="progress-${id}" class="bar-fill"></div>
                        </div>
                    </div>
                    <button onclick="lvlUp('${id}')" id="btn-lvl-${id}" data-cost="${s.cost}" class="bg-emerald-500 text-white px-3 py-2 rounded-lg game-font text-[10px] min-w-[70px] border-b-4 border-emerald-700 active:border-b-0 active:translate-y-1 transition">
                        ${s.cost}g
                    </button>
                `;
                container.appendChild(row);
            }
            updateStationVisuals();
        }

        function updateStationVisuals() {
            for(let id in stations) {
                let s = stations[id];
                let row = document.getElementById(`row-${id}`);
                
                // Visual Logic for Locked vs Unlocked
                if (!s.unlocked) {
                    // Locked
                    if (gold >= s.cost) {
                        row.className = "station-row unlockable"; // Green
                        document.getElementById(`income-${id}`).innerText = "UNLOCK!";
                        document.getElementById(`btn-lvl-${id}`).innerText = "BUY";
                        document.getElementById(`btn-lvl-${id}`).classList.add('btn-pulse');
                    } else {
                        row.className = "station-row locked"; // Gray
                        document.getElementById(`income-${id}`).innerText = "LOCKED";
                        document.getElementById(`btn-lvl-${id}`).innerText = formatNum(s.cost) + "g";
                        document.getElementById(`btn-lvl-${id}`).classList.remove('btn-pulse');
                    }
                } else {
                    // Unlocked
                    row.className = "station-row";
                    document.getElementById(`income-${id}`).innerText = `+${formatNum(Math.floor(s.income * globalMult))}g`;
                    document.getElementById(`btn-lvl-${id}`).classList.remove('btn-pulse');
                    
                    let btn = document.getElementById(`btn-lvl-${id}`);
                    if(s.lvl >= s.max) {
                        btn.innerText = "MAX";
                        btn.setAttribute('data-cost', 999999999999);
                    } else {
                        btn.innerText = `${formatNum(s.cost)}g`;
                        btn.setAttribute('data-cost', s.cost);
                    }
                }

                document.getElementById(`lvl-${id}`).innerText = `Lv.${s.lvl}`;

                let starCount = Math.floor(s.lvl / 10);
                let stars = "";
                for(let i=0; i<5; i++) stars += `<span class="${i < starCount ? 'star-active' : 'star-empty'}">‚òÖ</span>`;
                document.getElementById(`stars-${id}`).innerHTML = stars;
            }
        }

        // --- DOM RENDERER (SHOP) ---
        function initShopDOM() {
            let container = document.getElementById('shop-list');
            container.innerHTML = "";
            infrastructure.forEach(upg => {
                let div = document.createElement('div');
                div.id = `shop-item-${upg.id}`;
                div.className = "bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm animate__animated animate__fadeIn";
                div.style.display = "none"; 
                
                div.innerHTML = `
                    <div><p class="font-bold text-sm text-slate-700">${upg.name}</p><p class="text-[10px] text-slate-400">${upg.desc}</p></div>
                    <button onclick="buyUpgrade(${upg.id})" id="btn-shop-${upg.id}" data-cost="${upg.cost}" class="bg-emerald-500 text-white px-4 py-2 rounded-xl font-bold text-xs shadow border-b-2 border-emerald-700">${formatNum(upg.cost)}g</button>
                `;
                container.appendChild(div);
            });
            
            let msg = document.createElement('div');
            msg.id = "shop-empty-msg";
            msg.className = 'text-center text-slate-400 text-xs mt-10';
            msg.innerHTML = "No upgrades available right now.<br>Unlock more stations!";
            container.appendChild(msg);
        }

        function updateShopVisuals() {
            let anyShown = false;
            infrastructure.forEach(upg => {
                let el = document.getElementById(`shop-item-${upg.id}`);
                if (upg.bought) {
                    el.style.display = 'none';
                    return;
                }
                if (stations[upg.type].unlocked) {
                    el.style.display = 'flex';
                    anyShown = true;
                } else {
                    el.style.display = 'none';
                }
            });
            document.getElementById('shop-empty-msg').style.display = anyShown ? 'none' : 'block';
        }

        function tick(id) {
            let s = stations[id];
            let bar = document.getElementById('progress-' + id);
            
            s.progress += (s.speed * boostX2 * 0.8); 
            
            if(s.progress >= 100) {
                s.progress = 0;
                let add = Math.floor(s.income * globalMult);
                gold += add; shiftEarnings += add;
                
                bar.style.transition = 'none';
                bar.style.width = '0%';
                setTimeout(() => { bar.style.transition = 'width 0.1s linear'; }, 50);

                if(add > 10) spawnFloatText(bar, `+${formatNum(add)}`);
                
                if(dailyQuest.type === 'earn') {
                    dailyQuest.current += add;
                    updateQuestUI();
                }

            } else {
                bar.style.width = s.progress + '%';
            }
        }

        // --- QUESTS ---
        function generateQuest() {
            const types = [
                { type: 'lvl', desc: "Level Up Stations", target: 3 + Math.floor(questCompletedCount/2) },
                { type: 'click', desc: "Tap Adventurers", target: 5 + questCompletedCount },
                { type: 'earn', desc: "Earn Gold", target: (5000 * (day)) + (questCompletedCount * 1000) }
            ];
            let q = types[questCompletedCount % types.length];
            dailyQuest = { ...q, current: 0, reward: 50 + (questCompletedCount*20) };
            
            document.getElementById('quest-banner').classList.remove('opacity-50');
            updateQuestUI();
        }

        function updateQuestUI() {
            document.getElementById('quest-label').innerText = `Quest #${questCompletedCount + 1}`;
            document.getElementById('quest-desc').innerText = dailyQuest.desc;
            document.getElementById('quest-progress').innerText = `${formatNum(Math.floor(dailyQuest.current))}/${formatNum(dailyQuest.target)}`;
            document.getElementById('quest-reward-text').innerText = `Reward: ${dailyQuest.reward} üè†`;
            
            if(dailyQuest.current >= dailyQuest.target) {
                pGold += dailyQuest.reward;
                document.getElementById('p-gold-display').innerText = formatNum(pGold);
                spawnFloatText(document.getElementById('quest-banner'), `+${dailyQuest.reward} pGold`, true);
                
                questCompletedCount++;
                generateQuest();
            }
        }

        // --- ADVENTURERS ---
        function spawnAdventurer() {
            const emojis = ["üßù‚Äç‚ôÄÔ∏è", "üßô‚Äç‚ôÇÔ∏è", "üßö", "ü§¥", "üßü"];
            let div = document.createElement('div');
            div.className = "adventurer pointer-events-auto";
            div.innerText = emojis[Math.floor(Math.random()*emojis.length)];
            div.style.top = (10 + Math.random() * 60) + "%"; 
            div.onclick = function() {
                this.remove();
                let reward = Math.floor(10 + (gold * 0.05));
                gold += reward;
                spawnFloatText(this, `+${formatNum(reward)}g`, true);
                
                if(dailyQuest.type === 'click') {
                    dailyQuest.current++;
                    updateQuestUI();
                }
            };
            document.getElementById('adventurer-layer').appendChild(div);
            setTimeout(() => { if(div.parentElement) div.remove(); }, 10000);
        }

        function spawnFloatText(element, text, big = false) {
            let rect = element.getBoundingClientRect();
            let div = document.createElement('div');
            div.className = "float-text";
            if(big) div.style.fontSize = "20px";
            div.innerText = text;
            div.style.left = (rect.left + 20) + "px";
            div.style.top = rect.top + "px";
            document.getElementById('float-layer').appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        // --- ACTIONS ---
        function lvlUp(id) {
            let s = stations[id];
            if(s.lvl < s.max && gold >= s.cost) {
                gold -= s.cost; s.lvl++; s.unlocked = true;
                s.income = Math.floor(s.income * 1.2); 
                s.cost = Math.floor(s.cost * 1.5); 
                
                totalUpgradesPurchased++;
                updateStationVisuals();
                updateShopVisuals(); 
                checkButtons();
                
                if(dailyQuest.type === 'lvl') {
                    dailyQuest.current++;
                    updateQuestUI();
                }
                
                if(id === 'magic' && s.lvl >= s.max) {
                    document.getElementById('relocate-btn-container').classList.remove('hidden');
                }
            }
        }

        function buyUpgrade(id) {
            let upg = infrastructure.find(u => u.id === id);
            if(gold >= upg.cost) { 
                gold -= upg.cost; upg.bought = true; 
                totalUpgradesPurchased++;
                let s = stations[upg.type];
                if(upg.desc.includes("Speed")) s.speed *= 2; else s.income *= 2;
                updateShopVisuals(); 
                updateStationVisuals();
            }
        }

        function buyPartner(i) {
            let gift = partnerGifts[i];
            let cost = Math.floor(gift.baseCost * Math.pow(1.5, gift.lvl));
            
            if(pGold >= cost) {
                pGold -= cost;
                gift.lvl++;
                totalUpgradesPurchased++;
                
                // Benefit: Increase Global Multiplier
                globalMult += (i === 2 ? 0.25 : (i === 1 ? 0.1 : 0.05));

                document.getElementById('p-gold-display').innerText = formatNum(pGold);
                document.getElementById('partner-acc').innerText = gift.icon;
                renderBondItems();
            }
        }

        function buyFurniture(i) {
            let furn = homeFurniture[i];
            let cost = Math.floor(furn.baseCost * Math.pow(1.5, furn.lvl));
            
            if(pGold >= cost) {
                pGold -= cost;
                furn.lvl++;
                totalUpgradesPurchased++;
                
                // Benefit: Increase Commission Rate
                commissionMult += (i === 2 ? 0.05 : (i === 1 ? 0.02 : 0.01));

                document.getElementById('p-gold-display').innerText = formatNum(pGold);
                renderBondItems();
            }
        }

        function renderBondItems() {
            let pCont = document.getElementById('partner-shop');
            pCont.innerHTML = "";
            partnerGifts.forEach((g, i) => {
                let cost = Math.floor(g.baseCost * Math.pow(1.5, g.lvl));
                pCont.innerHTML += `
                    <div class="flex justify-between items-center bg-pink-50 p-3 rounded-xl mb-2">
                        <div><span class="text-xs font-bold text-pink-600">${g.name}</span><span class="block text-[8px] text-slate-400">${g.desc}</span></div>
                        <button onclick="buyPartner(${i})" id="btn-pgold-p${i}" data-cost="${cost}" class="bg-pink-400 text-white px-3 py-1 rounded-lg text-[10px] shadow border-b-2 border-pink-600">${formatNum(cost)}g</button>
                    </div>`;
            });

            let fCont = document.getElementById('home-shop');
            fCont.innerHTML = "";
            homeFurniture.forEach((f, i) => {
                let cost = Math.floor(f.baseCost * Math.pow(1.5, f.lvl));
                fCont.innerHTML += `
                    <div class="flex justify-between items-center bg-blue-50 p-3 rounded-xl mb-2">
                        <span class="text-xs font-bold text-blue-600">${f.name}</span>
                        <button onclick="buyFurniture(${i})" id="btn-pgold-f${i}" data-cost="${cost}" class="bg-blue-400 text-white px-3 py-1 rounded-lg text-[10px] shadow border-b-2 border-blue-600">${formatNum(cost)}g</button>
                    </div>`;
            });
        }

        // --- PRESTIGE & RETIRE ---
        function showPrestigeModal() {
            document.getElementById('current-loc').innerText = locations[prestigeLevel];
            document.getElementById('next-loc').innerText = locations[prestigeLevel+1] || "Kingdom";
            document.getElementById('prestige-modal').classList.remove('hidden');
        }
        function closePrestige() { document.getElementById('prestige-modal').classList.add('hidden'); }
        function confirmPrestige() {
            prestigeLevel++;
            globalMult *= 2;
            gold = 100;
            for(let id in stations) {
                stations[id].lvl = 0; stations[id].progress = 0;
                stations[id].unlocked = (id === 'clerk');
                const baseCosts = {clerk:50, quest:250, alch:1000, tavern:5000, smith:15000, magic:50000};
                stations[id].cost = baseCosts[id];
            }
            closePrestige();
            document.getElementById('loc-display').innerText = locations[prestigeLevel];
            document.getElementById('relocate-btn-container').classList.add('hidden');
            initStationDOM();
        }

        function retireGame() {
            // Stop Loops
            if(window.gameIntervals) {
                window.gameIntervals.forEach(clearInterval);
            }
            
            // Calc stats
            let m = Math.floor(totalTimePlayed / 60);
            let s = totalTimePlayed % 60;
            
            document.getElementById('end-time-display').innerText = `${m}m ${s}s`;
            document.getElementById('end-upgrades-display').innerText = totalUpgradesPurchased;
            
            document.getElementById('end-screen').classList.remove('hidden');
        }

        // --- TRANSITIONS ---
        function autoGoHome() {
            isShiftActive = false;
            currentShiftTime = 0;
            document.body.classList.add('night-mode');
            document.getElementById('header-1').classList.add('bg-slate-800', 'text-white');
            document.getElementById('header-2').classList.add('bg-slate-900', 'border-slate-700');

            let commission = Math.floor(shiftEarnings * commissionMult);
            pGold += commission;
            document.getElementById('earnings-display').innerText = `+${formatNum(commission)}g`;
            document.getElementById('p-gold-display').innerText = formatNum(pGold);
            
            if(day % 7 === 0) {
                document.getElementById('date-night-banner').classList.remove('hidden');
                document.getElementById('bond-msg').innerText = "It's our special night!";
                document.getElementById('partner-base').innerText = "üíë";
            } else {
                document.getElementById('date-night-banner').classList.add('hidden');
                document.getElementById('bond-msg').innerText = "Shift is over! Time to rest.";
                document.getElementById('partner-base').innerText = "üë§";
            }
            renderBondItems();
            switchTab('tab-bond');
        }

        function startNextDay() {
            day++;
            shiftEarnings = 0;
            currentShiftTime = SHIFT_DURATION;
            isShiftActive = true;
            document.body.classList.remove('night-mode');
            document.getElementById('header-1').classList.remove('bg-slate-800', 'text-white');
            document.getElementById('header-2').classList.remove('bg-slate-900', 'border-slate-700');
            document.getElementById('day-display').innerText = day;
            renderEpisodes();
            switchTab('tab-guild', document.getElementById('btn-guild'));
        }

        // --- UTILS ---
        function updateStatsUI() {
            let m = Math.floor(totalTimePlayed / 60);
            document.getElementById('stat-time').innerText = `${m}m`;
            document.getElementById('stat-upgrades').innerText = totalUpgradesPurchased;
        }

        function formatNum(n) {
            if(n >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if(n >= 1000) return (n/1000).toFixed(1) + 'k';
            return n.toLocaleString();
        }

        function checkButtons() {
            document.querySelectorAll('[id^="btn-lvl-"]').forEach(btn => {
                let cost = parseInt(btn.getAttribute('data-cost'));
                let isMax = btn.innerText === "MAX";
                if(gold < cost && !isMax) btn.classList.add('btn-disabled'); else btn.classList.remove('btn-disabled');
            });
            document.querySelectorAll('[id^="btn-shop-"]').forEach(btn => {
                let cost = parseInt(btn.getAttribute('data-cost'));
                if(gold < cost) btn.classList.add('btn-disabled'); else btn.classList.remove('btn-disabled');
            });
            document.querySelectorAll('[id^="btn-pgold-"]').forEach(btn => {
                let cost = parseInt(btn.getAttribute('data-cost'));
                if(pGold < cost) btn.classList.add('btn-disabled'); else btn.classList.remove('btn-disabled');
            });
        }

        function activateBoost() {
            if(boostSeconds > 0) return;
            document.getElementById('custom-alert').classList.remove('hidden');
        }
        function closeAlert() {
            document.getElementById('custom-alert').classList.add('hidden');
            boostSeconds = 300; boostX2 = 2.0;
            document.getElementById('btn-boost').classList.add('boost-active');
            document.getElementById('boost-timer-ui').classList.add('visible');
        }

        function renderEpisodes() {
            let cont = document.getElementById('episode-list');
            cont.innerHTML = "";
            episodes.forEach(ep => {
                if(day >= ep.day) {
                    cont.innerHTML += `<div class="p-2 border-l-2 border-cyan-400 pl-2 bg-slate-50 rounded mb-1">Day ${ep.day}: ${ep.text}</div>`;
                }
            });
        }

        function switchTab(id, btn) {
            if(!isShiftActive && id !== 'tab-bond') return;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(btn) btn.classList.add('active');
            checkButtons();
        }

        function formatTime(s) {
            let m = Math.floor(s/60);
            let sec = s%60;
            return m + ":" + sec.toString().padStart(2,'0');
        }
    </script>
</body>
</html>